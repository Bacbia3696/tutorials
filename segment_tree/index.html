<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lazy Propagation Lab</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=IBM+Plex+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../shared/tutorial-base.css" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="bg-orb orb-a"></div>
    <div class="bg-orb orb-b"></div>

    <main class="layout">
      <header class="hero panel">
        <p class="eyebrow">Segment Tree Playground</p>
        <h1>Lazy Propagation Lab</h1>
        <p class="hero-copy">
          Explore how range updates are deferred with lazy tags, then resolved only when needed.
          Run each operation instantly, animate it, or step through every recursive call.
        </p>
      </header>

      <section class="controls panel">
        <div class="control-group">
          <label for="arrayInput">Initial Array (comma or space separated, max 16)</label>
          <div class="row">
            <input id="arrayInput" type="text" value="3, 1, 4, 1, 5, 9, 2, 6" />
            <button id="loadArrayBtn" class="btn">Load Array</button>
            <button id="randomArrayBtn" class="btn btn-muted">Random</button>
          </div>
        </div>

        <div class="control-grid">
          <div class="control-group">
            <label for="opType">Operation</label>
            <select id="opType">
              <option value="update">Range Add Update</option>
              <option value="query">Range Sum Query</option>
            </select>
          </div>

          <div class="control-group">
            <label for="leftIndex">Left Index (L)</label>
            <input id="leftIndex" type="number" min="0" value="2" />
          </div>

          <div class="control-group">
            <label for="rightIndex">Right Index (R)</label>
            <input id="rightIndex" type="number" min="0" value="6" />
          </div>

          <div class="control-group" id="deltaWrap">
            <label for="deltaValue">Delta (+V)</label>
            <input id="deltaValue" type="number" value="3" />
          </div>
        </div>

        <div class="row wrap">
          <button id="animateBtn" class="btn btn-primary">Run Animated</button>
          <button id="stepBtn" class="btn">Step</button>
          <button id="instantBtn" class="btn">Apply Instantly</button>
          <button id="finishBtn" class="btn btn-muted">Finish Current</button>

          <div class="speed-wrap">
            <label for="speedRange">Animation Speed</label>
            <input id="speedRange" type="range" min="120" max="1400" step="20" value="520" />
            <span id="speedLabel">520 ms</span>
          </div>
        </div>
        <p class="key-hint">
          Shortcuts: <kbd>A</kbd> animate, <kbd>S</kbd> step, <kbd>I</kbd> instant,
          <kbd>F</kbd> finish, <kbd>L</kbd> load array, <kbd>R</kbd> random,
          <kbd>U</kbd> update mode, <kbd>Q</kbd> query mode.
        </p>
      </section>

      <section class="array-view panel">
        <h2>Base Array (naive reference)</h2>
        <div id="arrayStrip" class="array-strip"></div>
      </section>

      <section class="tree-view panel">
        <h2>Segment Tree Nodes</h2>
        <p class="hint">
          Card format: <code>#node [l,r]</code>, <code>sum</code>, <code>lazy</code>. Active recursion node pulses.
        </p>
        <div id="treeContainer" class="tree-container"></div>
      </section>

      <section class="status panel">
        <div>
          <h2>Status</h2>
          <p id="statusMessage" role="status" aria-live="polite" aria-atomic="true">Ready. Load an array and choose an operation.</p>
        </div>
        <div class="status-metrics">
          <p><span class="metric-label">Current Sum (root):</span> <span id="rootSum">-</span></p>
          <p><span class="metric-label">Last Query Result:</span> <span id="queryResult">-</span></p>
          <p><span class="metric-label">Step:</span> <span id="stepCounter">0 / 0</span></p>
        </div>
      </section>

      <section class="code panel">
        <h2>Algorithm Lens</h2>
        <div class="code-grid">
          <div class="code-panel" data-op="update">
            <h3>Range Add Update</h3>
            <ol>
              <li data-line="1">Visit node</li>
              <li data-line="2">Resolve pending lazy tag on current node</li>
              <li data-line="3">Push pending tag to children if internal node</li>
              <li data-line="4">Return if no overlap</li>
              <li data-line="5">If total overlap: update sum and mark children lazy</li>
              <li data-line="6">Otherwise recurse, then recompute sum from children</li>
            </ol>
          </div>

          <div class="code-panel" data-op="query">
            <h3>Range Sum Query</h3>
            <ol>
              <li data-line="1">Visit node</li>
              <li data-line="2">Resolve pending lazy tag on current node</li>
              <li data-line="3">Push pending tag to children if internal node</li>
              <li data-line="4">Return 0 if no overlap</li>
              <li data-line="5">If total overlap: return node sum</li>
              <li data-line="6">Otherwise recurse and return left + right</li>
            </ol>
          </div>
        </div>
      </section>

      <section class="log panel">
        <div class="row between">
          <h2>Trace Log</h2>
          <button id="clearLogBtn" class="btn btn-muted">Clear Log</button>
        </div>
        <div id="logOutput" class="log-output" role="log" aria-live="polite" aria-relevant="additions"></div>
      </section>
    </main>

    <script type="module" src="app.js"></script>
  </body>
</html>
